## 12.2. 回顾：ISA
ISA总线在设计上相当老旧，而且性能很差，但它仍然在扩展设备市场中占有很大一部分。如果速度不重要，并且您希望支持旧主板，则 ISA 实施比 PCI 更可取。这个旧标准的另一个优点是，如果你是一个电子爱好者，你可以很容易地构建自己的ISA设备，这在PCI中绝对是不可能的。

另一方面，ISA 的一大缺点是它与 PC 架构紧密绑定;接口总线具有 80286 处理器的所有局限性，给系统程序员带来了无尽的痛苦。ISA设计（继承自原始IBM PC）的另一个大问题是缺乏地理寻址，这导致了许多问题和冗长的拔出-重新跳线-插入-测试周期来添加新设备。有趣的是，即使是最老的Apple II电脑也已经在利用地理寻址，并且它们具有无跳线扩展板。

尽管ISA有很大的缺点，但它仍然在几个意想不到的地方使用。例如，用于多个掌上电脑的 VR41xx 系列 MIPS 处理器具有兼容 ISA 的扩展总线，这看起来很奇怪。ISA 的这些意外使用背后的原因是一些传统硬件（例如基于 8390 的以太网卡）的成本极低，因此具有 ISA 电信号的 CPU 可以很容易地利用糟糕但便宜的 PC 设备。

### 12.2.1. 硬件资源
ISA 设备可以配备 I/O 端口、存储区和中断线。

尽管 x86 处理器支持 64 KB 的 I/O 端口内存（即处理器断言 16 个地址线），但某些旧的 PC 硬件仅解码最低的 10 个地址线。这会将可用地址空间限制为 1024 个端口，因为 1 KB 到 64 KB 范围内的任何地址都会被仅解码低地址行的任何设备误认为是低地址。一些外设通过仅将一个端口映射到低千字节并使用高地址线在不同的器件寄存器之间进行选择来规避此限制。例如，映射在0x340的设备可以安全地使用端口 0x740、0xB40 等。

如果 I/O 端口的可用性受到限制，内存访问会更差。ISA 设备只能使用 640 KB 到 1 MB 以及 15 MB 到 16 MB 之间的内存范围进行 I/O 寄存器和设备控制。640 KB 到 1 MB 的范围由 PC BIOS、兼容 VGA 的视频板和各种其他设备使用，几乎没有空间可用于新设备。另一方面，Linux 并不直接支持 15 MB 的内存，现在破解内核来支持它是浪费编程时间。

ISA 设备板可用的第三个资源是中断线。有限数量的中断线被路由到 ISA 总线，它们由所有接口板共享。因此，如果设备配置不正确，它们可能会发现自己使用相同的中断线。

尽管原始 ISA 规范不允许跨设备共享中断，但大多数设备板都允许这样做。[5]第 10 章介绍了软件级别的中断共享。
 
 > 中断共享的问题是电气工程问题：如果设备通过施加低阻抗电压电平使信号线处于非活动状态，则无法共享中断。另一方面，如果器件使用上拉电阻至非活动逻辑电平，则可实现共享。这是当今的常态。但是，由于 ISA 中断是边沿触发的，而不是电平触发的，因此仍然存在丢失中断事件的潜在风险。边沿触发的中断更容易在硬件中实现，但不适合安全共享。

### 12.2.2. ISA编程
就编程而言，内核或BIOS中没有特定的帮助来简化对ISA设备的访问（例如，PCI）。您可以使用的唯一工具是 I/O 端口和 IRQ 线路的注册表，如第 10.2 节所述。

本书第一部分介绍的编程技术适用于 ISA 设备;驱动程序可以探测 I/O 端口，并且必须使用第 10.2.2 节中所示的技术之一自动检测中断线。

辅助功能isa_readb和好友在第 9 章中已经简要介绍过了，关于它们就不多说了。

### 12.2.3. 即插即用规范
一些新的ISA设备板遵循特殊的设计规则，需要特殊的初始化顺序，旨在简化附加接口板的安装和配置。这些板的设计规范称为即插即用 （PnP），由用于构建和配置无跳线 ISA 设备的繁琐规则集组成。PnP 设备实现可重定位的 I/O 区域;PC 的 BIOS 负责重新定位，让人想起 PCI。

简而言之，PnP 的目标是在不改变底层电气接口（ISA 总线）的情况下获得与 PCI 设备相同的灵活性。为此，规范定义了一组与设备无关的配置寄存器，以及一种在地理上寻址接口板的方法，即使物理总线不承载每块板（地理）布线，每条ISA信号线都连接到每个可用插槽。

地理寻址的工作原理是将一个小整数（称为卡选择号 （CSN））分配给计算机中的每个 PnP 外围设备。每个 PnP 器件都有一个 64 位宽的唯一串行标识符，该标识符硬连线到外设板中。CSN 分配使用唯一的序列号来标识 PnP 设备。但是，CSN 只能在启动时安全分配，这要求 BIOS 能够识别 PnP。因此，旧计算机要求用户获取并插入特定的配置软盘，即使设备支持 PnP。

遵循 PnP 规范的接口板在硬件级别很复杂。它们比PCI板要复杂得多，并且需要复杂的软件。安装这些设备时遇到困难并不罕见，即使安装顺利，您仍然面临 ISA 总线的性能限制和有限的 I/O 空间。最好尽可能安装PCI设备，并享受新技术。

如果您对 PnP 配置软件感兴趣，可以浏览 drivers/net/3c509.c，其探测功能处理 PnP 设备。2.6 内核在 PnP 设备支持领域做了大量工作，因此与以前的内核版本相比，许多不灵活的接口已被清理。
